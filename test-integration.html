<!DOCTYPE html>
<html>
<head>
    <title>Integration Test</title>
</head>
<body>
    <div id="test-output">
        <h2>Integration Test Results</h2>
        <div id="results">Running tests...</div>
    </div>

    <script type="module">
        const results = document.getElementById('results');

        function log(message, isError = false) {
            console.log(message);
            const div = document.createElement('div');
            div.style.color = isError ? 'red' : 'green';
            div.textContent = message;
            results.appendChild(div);
        }

        // Mock browser APIs
        window.performance = {
            now: () => Date.now(),
            mark: () => {},
            measure: () => {},
            getEntriesByType: () => [],
            getEntriesByName: () => []
        };

        window.requestAnimationFrame = (cb) => setTimeout(cb, 16);
        window.PerformanceObserver = class {
            constructor() {}
            observe() {}
        };

        // Mock Firebase APIs
        window.firebase = {
            apps: [],
            initializeApp: () => ({
                firestore: () => ({}),
                storage: () => ({}),
                auth: () => ({})
            })
        };

        // Mock DOM elements
        document.getElementById = (id) => {
            const mockElements = {
                'restaurants-grid': { innerHTML: '', appendChild: () => {}, querySelectorAll: () => [] },
                'empty-state': { style: { display: 'none' } },
                'connection-indicator': { className: '', textContent: '' },
                'add-restaurant-btn': { addEventListener: () => {} }
            };
            return mockElements[id] || { style: {}, textContent: '', innerHTML: '' };
        };

        document.querySelector = () => null;
        document.createElement = (tag) => ({
            className: '',
            innerHTML: '',
            textContent: '',
            style: {},
            setAttribute: () => {},
            appendChild: () => {},
            addEventListener: () => {}
        });

        document.createDocumentFragment = () => ({
            appendChild: () => {}
        });

        async function runTests() {
            try {
                log('ğŸ§ª Starting integration tests...');

                // Test 1: Bundle Optimizer
                log('ğŸ“¦ Testing Bundle Optimizer...');
                const { getBundleOptimizer } = await import('./js/utils/bundle-optimizer.js');
                const bundleOptimizer = getBundleOptimizer();
                log('âœ… Bundle Optimizer loaded successfully');

                // Test 2: Performance Monitor
                log('ğŸ“Š Testing Performance Monitor...');
                const { getPerformanceMonitor } = await import('./js/services/performance-monitor.js');
                const performanceMonitor = getPerformanceMonitor();
                log('âœ… Performance Monitor loaded successfully');

                // Test 3: UI Service
                log('ğŸ¨ Testing UI Service...');
                const { UIService } = await import('./js/modules/ui-service.js');
                const uiService = new UIService();
                log('âœ… UI Service loaded successfully');

                // Test 4: Dependency injection
                log('ğŸ”— Testing dependency injection...');
                uiService.setPerformanceMonitor(performanceMonitor);
                log('âœ… Dependency injection successful');

                // Test 5: Test the problematic setupCardRenderMonitoring
                log('ğŸš¨ Testing setupCardRenderMonitoring (the problematic method)...');
                window.uiService = uiService;
                window.performanceMonitor = performanceMonitor;

                performanceMonitor.setupCardRenderMonitoring();
                log('âœ… setupCardRenderMonitoring completed without errors!');

                log('ğŸ‰ ALL TESTS PASSED! The initialization issue has been resolved.');

            } catch (error) {
                log(`âŒ Test failed: ${error.message}`, true);
                log(`Stack: ${error.stack}`, true);
            }
        }

        runTests();
    </script>
</body>
</html>