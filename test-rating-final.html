<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Rating Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .result { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        button { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; margin: 5px; }
        button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <h1>üß™ Teste Final do Sistema de Avalia√ß√£o</h1>
    <button onclick="testRatingSubmission()">‚≠ê Testar Submiss√£o de Avalia√ß√£o</button>
    <button onclick="checkRestaurantData()">üçΩÔ∏è Verificar Dados do Restaurante</button>
    <button onclick="checkRatingData()">üìä Verificar Avalia√ß√µes Salvas</button>
    <div id="results"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="src/firebase-config.js"></script>

    <script type="module">
        import { FingerprintService } from './js/services/fingerprint-service.js';
        import { UserIdentificationService } from './js/services/user-identification-service.js';

        window.addResult = function(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(result);
        };

        window.testRatingSubmission = async function() {
            try {
                addResult('üöÄ Iniciando teste completo de avalia√ß√£o...', 'info');

                // Initialize services
                const fingerprintService = new FingerprintService();
                const identificationService = new UserIdentificationService();

                // Create/get test user
                let userData;
                if (identificationService.isUserIdentified()) {
                    userData = identificationService.getUserData();
                    addResult(`‚úÖ Usu√°rio existente: ${userData.userName}`, 'success');
                } else {
                    const initResult = await identificationService.initializeUserIdentification();
                    if (initResult.needsIdentification) {
                        userData = await identificationService.completeIdentification('Usu√°rio Teste Final');
                        addResult(`‚úÖ Novo usu√°rio criado: ${userData.userName}`, 'success');
                    } else {
                        userData = initResult;
                    }
                }

                // Import StorageService
                const { StorageService } = await import('./js/services/storage-service.js');
                const storageService = new StorageService(window.EsplanadaEatsFirebase.firebase);

                // Create test restaurant first
                const restaurantData = {
                    name: 'Restaurante Teste Avalia√ß√£o Final',
                    address: 'Endere√ßo Teste',
                    phone: '123456789',
                    category: 'Teste',
                    description: 'Restaurante para teste final de avalia√ß√£o',
                    price: 2,
                    averageQuality: 0,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                const restaurantRef = await window.EsplanadaEatsFirebase.db.collection('restaurants').add(restaurantData);
                const restaurantId = restaurantRef.id;
                addResult(`üçΩÔ∏è Restaurante teste criado: ${restaurantId}`, 'success');

                // Submit rating
                const ratingData = {
                    restaurantId: restaurantId,
                    restaurantName: restaurantData.name,
                    rating: 5,
                    userId: userData.userId,
                    userName: userData.userName,
                    userFingerprint: userData.fingerprint,
                    quality: 5,
                    taste: 5,
                    priceRating: 5,
                    ambiance: 4,
                    service: 5,
                    comment: 'Teste final do sistema de avalia√ß√£o',
                    moderationStatus: 'approved',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                addResult('‚≠ê Enviando avalia√ß√£o...', 'info');
                const ratingId = await storageService.createRating(ratingData);
                addResult(`üéâ AVALIA√á√ÉO SALVA COM SUCESSO! ID: ${ratingId}`, 'success');

                // Wait a moment and check restaurant update
                setTimeout(async () => {
                    await checkRestaurantUpdate(restaurantId);
                }, 2000);

            } catch (error) {
                addResult(`‚ùå ERRO: ${error.message}`, 'error');
                console.error('Detailed error:', error);
            }
        };

        window.checkRestaurantUpdate = async function(restaurantId) {
            try {
                addResult(`üîç Verificando atualiza√ß√£o do restaurante ${restaurantId}...`, 'info');

                const restaurantDoc = await window.EsplanadaEatsFirebase.db.collection('restaurants').doc(restaurantId).get();
                const restaurantData = restaurantDoc.data();

                if (restaurantData) {
                    addResult(`üìä Dados atualizados do restaurante:`, 'success');
                    addResult(`‚≠ê Qualidade m√©dia: ${restaurantData.averageQuality || 0}`, 'info');
                    addResult(`üçΩÔ∏è Total de avalia√ß√µes: ${restaurantData.totalReviews || 0}`, 'info');
                    addResult(`üòã Sabor m√©dio: ${restaurantData.averageTaste || 0}`, 'info');
                    addResult(`üí∞ Pre√ßo m√©dio: ${restaurantData.averagePrice || 0}`, 'info');

                    if (restaurantData.totalReviews > 0) {
                        addResult(`‚úÖ SUCESSO! As m√©dias est√£o sendo atualizadas corretamente!`, 'success');
                    } else {
                        addResult(`‚ö†Ô∏è O restaurante n√£o foi atualizado com as novas m√©dias`, 'error');
                    }
                } else {
                    addResult(`‚ùå Restaurante n√£o encontrado`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Erro ao verificar restaurante: ${error.message}`, 'error');
            }
        };

        window.checkRestaurantData = async function() {
            try {
                addResult('üîç Buscando dados dos restaurantes...', 'info');
                const snapshot = await window.EsplanadaEatsFirebase.db.collection('restaurants').limit(5).get();

                addResult(`üìä Encontrados ${snapshot.size} restaurantes:`, 'info');
                snapshot.forEach(doc => {
                    const data = doc.data();
                    addResult(`üçΩÔ∏è ${data.name} - Qualidade: ${data.averageQuality || 0} - Avalia√ß√µes: ${data.totalReviews || 0}`, 'info');
                });
            } catch (error) {
                addResult(`‚ùå Erro ao buscar restaurantes: ${error.message}`, 'error');
            }
        };

        window.checkRatingData = async function() {
            try {
                addResult('üîç Buscando avalia√ß√µes salvas...', 'info');
                const snapshot = await window.EsplanadaEatsFirebase.db.collection('ratings').limit(5).get();

                addResult(`üìä Encontradas ${snapshot.size} avalia√ß√µes:`, 'info');
                snapshot.forEach(doc => {
                    const data = doc.data();
                    addResult(`‚≠ê ${data.userName} - ${data.rating} estrelas - ${data.restaurantName}`, 'info');
                });
            } catch (error) {
                addResult(`‚ùå Erro ao buscar avalia√ß√µes: ${error.message}`, 'error');
            }
        };

        // Initialize
        addResult('üì± P√°gina de teste final carregada', 'success');
    </script>
</body>
</html>