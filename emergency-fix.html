<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corre√ß√£o Emergencial de Avalia√ß√µes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            margin-top: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Corre√ß√£o Emergencial de Avalia√ß√µes</h1>

        <div class="danger">
            <strong>‚ö†Ô∏è FERRAMENTA DE CORRE√á√ÉO EMERGENCIAL</strong><br>
            Este script ir√° corrigir diretamente as contagens de avalia√ß√µes no Firebase<br>
            sem passar pelos m√©todos complexos que est√£o falhando.
        </div>

        <div>
            <button class="btn btn-success" onclick="emergencyFixCounts()">
                üö® CORRIGIR CONTAGENS AGORA
            </button>
            <button class="btn" onclick="verifyFix()">
                üîç VERIFICAR CORRE√á√ÉO
            </button>
            <button class="btn" onclick="location.href='/'">
                üè† VOLTAR AO APP
            </button>
        </div>

        <div id="log" class="log">Aguardando corre√ß√£o emergencial...</div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="src/firebase-config.js?v=2.1.0"></script>

    <script>
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.emergencyFixCounts = async function() {
            try {
                log('üö® INICIANDO CORRE√á√ÉO EMERGENCIAL...', 'error');

                if (!window.EsplanadaEatsFirebase || !window.EsplanadaEatsFirebase.firebase) {
                    throw new Error('Firebase n√£o inicializado');
                }

                const { firebase } = window.EsplanadaEatsFirebase;
                const db = firebase.firestore();

                // Get all restaurants
                const restaurantsSnapshot = await db.collection('restaurants').get();
                log(`üìä Encontrados ${restaurantsSnapshot.size} restaurantes para corrigir`);

                // Get all ratings
                const ratingsSnapshot = await db.collection('ratings').get();
                log(`üìä Encontradas ${ratingsSnapshot.size} avalia√ß√µes no total`);

                // Group ratings by restaurant
                const ratingsByRestaurant = {};
                ratingsSnapshot.forEach(doc => {
                    const rating = doc.data();
                    const restaurantId = rating.restaurantId;
                    if (!ratingsByRestaurant[restaurantId]) {
                        ratingsByRestaurant[restaurantId] = [];
                    }
                    ratingsByRestaurant[restaurantId].push(rating);
                });

                log('üìä An√°lise de avalia√ß√µes por restaurante:');
                Object.keys(ratingsByRestaurant).forEach(restaurantId => {
                    log(`   ${restaurantId}: ${ratingsByRestaurant[restaurantId].length} avalia√ß√µes`);
                });

                // Update each restaurant
                let successCount = 0;
                let errorCount = 0;

                for (const doc of restaurantsSnapshot.docs) {
                    const restaurant = doc.data();
                    const restaurantId = doc.id;
                    const ratings = ratingsByRestaurant[restaurantId] || [];
                    const actualCount = ratings.length;

                    try {
                        log(`üîß Corrigindo: ${restaurant.name} (ID: ${restaurantId})`);
                        log(`   üìä Avalia√ß√µes reais: ${actualCount}`);

                        if (actualCount === 0) {
                            // Update restaurant with zero ratings
                            await db.collection('restaurants').doc(restaurantId).update({
                                totalRatings: 0,
                                averageQuality: 0,
                                ratingLastUpdated: new Date().toISOString()
                            });
                            log(`   ‚úÖ Atualizado: 0 avalia√ß√µes`, 'success');
                        } else {
                            // Calculate average rating
                            const totalRating = ratings.reduce((sum, rating) => {
                                return sum + (rating.rating || rating.quality || 0);
                            }, 0);
                            const averageQuality = Math.round((totalRating / actualCount) * 10) / 10;

                            // Update restaurant with correct counts
                            await db.collection('restaurants').doc(restaurantId).update({
                                totalRatings: actualCount,
                                averageQuality: averageQuality,
                                ratingLastUpdated: new Date().toISOString()
                            });
                            log(`   ‚úÖ Atualizado: ${actualCount} avalia√ß√µes, m√©dia ${averageQuality}`, 'success');
                        }

                        successCount++;

                    } catch (error) {
                        log(`   ‚ùå Erro ao atualizar ${restaurant.name}: ${error.message}`, 'error');
                        errorCount++;
                    }
                }

                log(`üéâ CORRE√á√ÉO CONCLU√çDA!`, 'success');
                log(`‚úÖ ${successCount} restaurantes atualizados com sucesso`, 'success');
                log(`‚ùå ${errorCount} restaurantes com erros`, errorCount > 0 ? 'error' : 'info');

                log('üìä Verificando corre√ß√£o...', 'info');
                setTimeout(verifyFix, 1000);

            } catch (error) {
                log(`‚ùå ERRO CR√çTICO NA CORRE√á√ÉO: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        };

        window.verifyFix = async function() {
            try {
                log('üîç VERIFICANDO CORRE√á√ÉO...', 'info');

                if (!window.EsplanadaEatsFirebase || !window.EsplanadaEatsFirebase.firebase) {
                    throw new Error('Firebase n√£o inicializado');
                }

                const { firebase } = window.EsplanadaEatsFirebase;
                const db = firebase.firestore();

                // Get restaurants
                const restaurantsSnapshot = await db.collection('restaurants').get();

                // Get ratings
                const ratingsSnapshot = await db.collection('ratings').get();

                // Group ratings by restaurant
                const ratingsByRestaurant = {};
                ratingsSnapshot.forEach(doc => {
                    const rating = doc.data();
                    const restaurantId = rating.restaurantId;
                    if (!ratingsByRestaurant[restaurantId]) {
                        ratingsByRestaurant[restaurantId] = [];
                    }
                    ratingsByRestaurant[restaurantId].push(rating);
                });

                log('üìä RESULTADO DA VERIFICA√á√ÉO:', 'success');

                let allCorrect = true;

                restaurantsSnapshot.forEach(doc => {
                    const restaurant = doc.data();
                    const restaurantId = doc.id;
                    const actualCount = ratingsByRestaurant[restaurantId] ? ratingsByRestaurant[restaurantId].length : 0;
                    const reportedCount = restaurant.totalRatings || 0;

                    const status = actualCount === reportedCount ? '‚úÖ' : '‚ùå';
                    const statusType = actualCount === reportedCount ? 'success' : 'error';

                    log(`${status} ${restaurant.name}: ${actualCount} reais vs ${reportedCount} reportadas`, statusType);

                    if (actualCount !== reportedCount) {
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    log('üéâ TODAS AS CONTAGENS EST√ÉO CORRETAS!', 'success');
                    log('‚úÖ Cards do app agora devem mostrar os valores corretos', 'success');
                } else {
                    log('‚ö†Ô∏è Ainda h√° discrep√¢ncias. Execute a corre√ß√£o novamente.', 'warning');
                }

            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            }
        };

        // Initialize
        log('üö® Ferramenta de corre√ß√£o emergencial carregada');
        log('üìã Clique em "CORRIGIR CONTAGENS AGORA" para for√ßar a corre√ß√£o');
    </script>
</body>
</html>