<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Rating Integration</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background: #1d4ed8; }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Test Firebase Rating Integration</h1>

    <div class="test-section">
        <h2>Environment Check</h2>
        <button onclick="checkFirebase()">Check Firebase</button>
        <button onclick="checkStorageService()">Check Storage Service</button>
        <button onclick="checkIdentification()">Check User Identification</button>
    </div>

    <div class="test-section">
        <h2>Submit Test Rating</h2>
        <p>Restaurant: Test Restaurant</p>
        <p>Rating: 5 stars</p>
        <button onclick="submitTestRating()">Submit Test Rating to Firebase</button>
        <button onclick="submitRatingFromUI()">Test with Rating UI</button>
    </div>

    <div id="results"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="src/firebase-config.js"></script>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-container" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="display: none;">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <button class="modal-close" aria-label="Fechar modal">&times;</button>
            <div id="modal-body">
                <!-- Modal content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { FingerprintService } from './js/services/fingerprint-service.js';
        import { UserIdentificationService } from './js/services/user-identification-service.js';
        import { ModalService } from './js/modules/modal-service.js';

        // Initialize services
        window.fingerprintService = new FingerprintService();
        window.identificationService = new UserIdentificationService();
        window.modalService = new ModalService();

        // Test logging
        window.addResult = function(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(result);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        };

        // Check Firebase
        window.checkFirebase = function() {
            try {
                if (window.EsplanadaEatsFirebase && window.EsplanadaEatsFirebase.firebase) {
                    addResult('✅ Firebase initialized successfully', 'success');
                    addResult(`Project ID: ${window.EsplanadaEatsFirebase.firebase.options.projectId}`, 'info');

                    // Test Firestore connection
                    const db = window.EsplanadaEatsFirebase.db;
                    addResult('✅ Firestore available', 'success');

                } else {
                    addResult('❌ Firebase not initialized', 'error');
                }
            } catch (error) {
                addResult(`❌ Firebase check error: ${error.message}`, 'error');
            }
        };

        // Check Storage Service
        window.checkStorageService = async function() {
            try {
                const { StorageService } = await import('./js/services/storage-service.js');
                const storageService = new StorageService(window.EsplanadaEatsFirebase.firebase);
                addResult('✅ StorageService initialized successfully', 'success');

                // Test getting restaurants
                const restaurants = await storageService.getRestaurants();
                addResult(`✅ Connected to Firestore - Found ${restaurants.length} restaurants`, 'success');

            } catch (error) {
                addResult(`❌ StorageService error: ${error.message}`, 'error');
                console.error('StorageService error:', error);
            }
        };

        // Check User Identification
        window.checkIdentification = async function() {
            try {
                if (window.identificationService.isUserIdentified()) {
                    const userData = window.identificationService.getUserData();
                    addResult(`✅ User identified: ${userData.userName}`, 'success');
                } else {
                    addResult('⚠️ User not identified - creating test user...', 'info');

                    // Create test user
                    const initResult = await window.identificationService.initializeUserIdentification();
                    if (initResult.needsIdentification) {
                        // Create test fingerprint and complete identification
                        const result = await window.identificationService.completeIdentification('Test User');
                        addResult(`✅ Test user created: ${result.userName}`, 'success');
                        addResult(`User ID: ${result.userId.substring(0, 16)}...`, 'info');
                    } else {
                        addResult(`✅ User already identified: ${initResult.userName}`, 'success');
                    }
                }
            } catch (error) {
                addResult(`❌ Identification error: ${error.message}`, 'error');
            }
        };

        // Submit test rating directly
        window.submitTestRating = async function() {
            try {
                addResult('Submitting test rating to Firebase...', 'info');

                // Ensure user is identified
                if (!window.identificationService.isUserIdentified()) {
                    await window.checkIdentification();
                }

                const currentUser = window.identificationService.getUserData();
                const { StorageService } = await import('./js/services/storage-service.js');
                const storageService = new StorageService(window.EsplanadaEatsFirebase.firebase);

                const ratingData = {
                    restaurantId: 'test-restaurant-direct',
                    restaurantName: 'Test Restaurant Direct',
                    rating: 5,
                    userId: currentUser.userId,
                    userName: currentUser.userName,
                    userFingerprint: currentUser.fingerprint,
                    timestamp: new Date().toISOString(),
                    quality: 5,
                    price: null,
                    service: null,
                    comment: 'Test rating from direct submission'
                };

                const ratingId = await storageService.createRating(ratingData);
                addResult(`✅ Test rating submitted successfully! ID: ${ratingId}`, 'success');
                addResult('Rating saved to Firebase Firestore', 'info');

            } catch (error) {
                addResult(`❌ Test rating submission failed: ${error.message}`, 'error');
                console.error('Test rating error:', error);
            }
        };

        // Test with Rating UI
        window.submitRatingFromUI = async function() {
            try {
                addResult('Testing rating with full UI...', 'info');

                // Ensure user is identified
                if (!window.identificationService.isUserIdentified()) {
                    await window.checkIdentification();
                }

                const mockRestaurant = {
                    id: 'test-restaurant-ui',
                    name: 'Test Restaurant UI',
                    description: 'Test restaurant for UI rating',
                    averageQuality: 4.0,
                    totalReviews: 10
                };

                const { RatingForm } = await import('./js/components/rating-form.js');
                const ratingForm = new RatingForm(
                    mockRestaurant,
                    window.modalService,
                    window.identificationService
                );

                const result = await ratingForm.show();

                if (result && result.success) {
                    addResult(`✅ UI Rating submitted successfully!`, 'success');
                    addResult(`Rating: ${result.rating} stars`, 'info');
                    addResult(`Rating ID: ${result.ratingId}`, 'info');
                    addResult(`User: ${result.user.userName}`, 'info');
                } else {
                    addResult('❌ UI Rating was cancelled or failed', 'error');
                }

            } catch (error) {
                addResult(`❌ UI Rating test failed: ${error.message}`, 'error');
                console.error('UI Rating error:', error);
            }
        };

        // Initialize
        addResult('Firebase Rating Test Page Loaded', 'success');
        window.checkFirebase();

    </script>
</body>
</html>