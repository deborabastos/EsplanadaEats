<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Direto - Rating Form</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; }
        .log { background: #f8f9fa; padding: 1rem; margin: 1rem 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .btn { background: #007bff; color: white; padding: 0.5rem 1rem; border: none; cursor: pointer; margin: 0.5rem; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üß™ Teste Direto do Rating Form</h1>
    <button class="btn" onclick="testRatingForm()">Testar Rating Form</button>
    <button class="btn" onclick="clearLog()">Limpar Log</button>
    <div id="log" class="log">Console aguardando...</div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="src/firebase-config.js?v=2.1.0"></script>

    <script>
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.testRatingForm = async function() {
            try {
                log('üß™ INICIANDO TESTE DIRETO DO RATING FORM...', 'info');

                if (!window.EsplanadaEatsFirebase || !window.EsplanadaEatsFirebase.firebase) {
                    throw new Error('Firebase n√£o inicializado');
                }

                const { firebase } = window.EsplanadaEatsFirebase;

                // Buscar um restaurante do Firebase
                const db = firebase.firestore();
                const snapshot = await db.collection('restaurants').limit(1).get();

                if (snapshot.empty) {
                    throw new Error('Nenhum restaurante encontrado');
                }

                const doc = snapshot.docs[0];
                const rawData = doc.data();
                const restaurantId = doc.id;

                // Criar objeto restaurante completo
                const restaurant = {
                    id: restaurantId,
                    name: rawData.name || 'Teste',
                    averageQuality: rawData.averageQuality || 0,
                    totalRatings: rawData.totalRatings || 0,
                    totalReviews: rawData.totalReviews || 0,
                    photoUrls: rawData.photoUrls || [],
                    // outros campos necess√°rios...
                };

                log(`üìä RESTAURANTE PARA TESTE:`, 'success');
                log(`   ID: ${restaurant.id}`);
                log(`   Nome: ${restaurant.name}`);
                log(`   averageQuality: ${restaurant.averageQuality}`);
                log(`   totalRatings: ${restaurant.totalRatings}`);

                // Carregar RatingForm dinamicamente
                log('üîß Carregando RatingForm...', 'info');

                try {
                    // Criar um modal service mock
                    const mockModalService = {
                        show: (content, title) => {
                            log('üé≠ MOCK MODAL - Mostrando conte√∫do:', 'info');
                            log(`   T√≠tulo: ${title}`, 'info');
                            log(`   Conte√∫do: ${content.substring(0, 200)}...`, 'info');

                            return new Promise((resolve) => {
                                // Mostrar o conte√∫do na p√°gina para teste
                                const testDiv = document.createElement('div');
                                testDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border: 2px solid #007bff; z-index: 1000; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
                                testDiv.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <h3>${title}</h3>
                                        <button onclick="window.mockModalResolve({ success: false, cancelled: true }); this.parentElement.parentElement.remove();" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; cursor: pointer; border-radius: 4px;">√ó</button>
                                    </div>
                                    <div id="mock-modal-content">
                                        ${content}
                                    </div>
                                `;
                                document.body.appendChild(testDiv);

                                // Store resolve function globally for test interaction
                                window.mockModalResolve = resolve;

                                // Create mock success function for RatingForm to call
                                window.mockModalSuccess = (result) => {
                                    log('üéâ MOCK MODAL SUCCESS - Rating form completed successfully!', 'success');
                                    log(`   Result: ${JSON.stringify(result)}`, 'success');
                                    resolve({ success: true, ...result });
                                    // Remove modal after a delay to show success message
                                    setTimeout(() => {
                                        const modalDiv = document.querySelector('[style*="position: fixed"]');
                                        if (modalDiv) {
                                            modalDiv.remove();
                                        }
                                    }, 2000);
                                };

                                log('‚úÖ MOCK MODAL - Modal exibido com sucesso, aguardando intera√ß√£o do usu√°rio...', 'success');
                            });
                        },
                        requireUserIdentification: async (restaurant, context) => {
                            log('üîê MOCK requireUserIdentification - Solicitando identifica√ß√£o...', 'info');
                            // Simular identifica√ß√£o bem-sucedida
                            return {
                                userId: 'test-user-' + Date.now(),
                                userName: 'Usu√°rio Teste',
                                fingerprint: 'test-fingerprint-' + Date.now()
                            };
                        },
                        close: () => {
                            log('üî¥ MOCK MODAL - Fechando modal...', 'info');
                            // Find and remove the modal
                            const modalDiv = document.querySelector('[style*="position: fixed"]');
                            if (modalDiv) {
                                modalDiv.remove();
                                log('‚úÖ MOCK MODAL - Modal removido da p√°gina', 'success');
                            }
                        },
                        showError: (message) => {
                            log(`‚ùå MOCK ERROR - ${message}`, 'error');
                            alert(`ERRO: ${message}`);
                        },
                        showNotification: (message, type = 'info') => {
                            log(`üîî MOCK NOTIFICATION - ${message} (${type})`, 'info');
                        }
                    };

                    // Criar identification service mock
                    const initialUserData = {
                        userId: 'test-user-' + Date.now(),
                        userName: 'Usu√°rio Teste',
                        fingerprint: 'test-fingerprint-' + Date.now()
                    };

                    const mockIdentificationService = {
                        isUserIdentified: () => true, // Usu√°rio j√° identificado para simplificar
                        identifyUser: async () => {
                            log('üë§ MOCK IDENTIFICATION - Usu√°rio j√° identificado, retornando dados...', 'info');
                            return initialUserData;
                        },
                        getUserData: () => {
                            log('üë§ MOCK getUserData - Retornando dados do usu√°rio...', 'info');
                            return initialUserData;
                        },
                        clearUserIdentification: () => {
                            log('üóëÔ∏è MOCK clearUserIdentification - Limpando identifica√ß√£o...', 'info');
                        },
                        // Propriedades para simular estado
                        isIdentified: true,
                        userData: initialUserData
                    };

                    // Importar RatingForm (vai funcionar?)
                    const { RatingForm } = await import('/js/components/rating-form.js');
                    log('‚úÖ RatingForm importado com sucesso!', 'success');

                    // Criar RatingForm
                    const ratingForm = new RatingForm(restaurant, mockModalService, mockIdentificationService);
                    log('‚úÖ RatingForm criado com sucesso!', 'success');

                    // Tentar mostrar o formul√°rio
                    log('üé≠ Tentando mostrar o formul√°rio...', 'info');
                    const result = await ratingForm.show();
                    log(`üìã Resultado do formul√°rio: ${JSON.stringify(result)}`, 'success');

                } catch (importError) {
                    log(`‚ùå Erro ao importar/criar RatingForm: ${importError.message}`, 'error');
                    log(`   Stack: ${importError.stack}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
                log(`   Stack: ${error.stack}`, 'error');
            }
        };

        window.clearLog = function() {
            logDiv.innerHTML = 'Console limpo...';
        };

        // Auto-test on load
        window.addEventListener('load', () => {
            log('üöÄ P√°gina de teste direto do RatingForm carregada');
            log('üìã Clique em "Testar Rating Form" para executar');
        });
    </script>
</body>
</html>