<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esplanada Eats - Avalia√ß√£o de Restaurantes</title>
    <meta name="description" content="Plataforma colaborativa para avalia√ß√£o de restaurantes na Esplanada">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../src/styles.css">

    <!-- Firebase Configuration -->
    <script src="../src/firebase-config.js"></script>

    <!-- Firebase Services Module -->
    <script type="module" src="../src/firebase.js"></script>
</head>
<body>
    <div class="container">
        <header class="text-center py-4">
            <h1>üçΩÔ∏è Esplanada Eats</h1>
            <p class="lead">Plataforma colaborativa para avalia√ß√£o de restaurantes</p>
        </header>

        <main>
            <!-- Connection Status -->
            <div id="connection-status" class="alert alert-info text-center">
                <span id="status-text">Verificando conex√£o...</span>
            </div>

            <!-- Firebase Test Section -->
            <section class="my-4">
                <h2>Firebase Connection Test</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Firestore Status</h5>
                            </div>
                            <div class="card-body">
                                <div id="firestore-status">Testing...</div>
                                <button class="btn btn-primary mt-2" onclick="testFirestore()">
                                    Test Firestore Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Storage Status</h5>
                            </div>
                            <div class="card-body">
                                <div id="storage-status">Testing...</div>
                                <button class="btn btn-primary mt-2" onclick="testStorage()">
                                    Test Storage Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Test Data Section -->
            <section class="my-4">
                <h2>Test Operations</h2>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Add Test Restaurant</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success" onclick="addTestRestaurant()">
                                    Add Test Restaurant
                                </button>
                                <div id="restaurant-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Add Test Review</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success" onclick="addTestReview()">
                                    Add Test Review
                                </button>
                                <div id="review-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Storage</h5>
                            </div>
                            <div class="card-body">
                                <input type="file" id="test-file" accept="image/*" class="form-control mb-2">
                                <button class="btn btn-success" onclick="testFileUpload()">
                                    Upload Test Image
                                </button>
                                <div id="upload-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Test Scripts -->
    <script>
        // Connection state monitoring
        function updateConnectionStatus(isOnline) {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');

            if (isOnline) {
                statusElement.className = 'alert alert-success text-center';
                statusText.textContent = '‚úÖ Conectado ao Firebase';
            } else {
                statusElement.className = 'alert alert-warning text-center';
                statusText.textContent = '‚ö†Ô∏è Offline - Modo offline ativado';
            }
        }

        // Monitor connection state
        firebase.firestore().enableNetwork()
            .then(() => {
                updateConnectionStatus(true);
            })
            .catch(() => {
                updateConnectionStatus(false);
            });

        // Test Firestore connection
        function testFirestore() {
            const statusDiv = document.getElementById('firestore-status');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

            // Try to write a test document
            const testRef = firebase.firestore().collection('test').doc('connection-test');
            testRef.set({
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                message: 'Firebase connection test'
            })
            .then(() => {
                statusDiv.innerHTML = '‚úÖ Firestore connection successful!';
                statusDiv.className = 'text-success';
            })
            .catch((error) => {
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'text-danger';
            });
        }

        // Test Storage connection
        function testStorage() {
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

            try {
                const storageRef = firebase.storage().ref();
                statusDiv.innerHTML = '‚úÖ Storage connection successful!';
                statusDiv.className = 'text-success';
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'text-danger';
            }
        }

        // Add test restaurant
        function addTestRestaurant() {
            const resultDiv = document.getElementById('restaurant-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Adding...';

            const restaurantData = {
                name: 'Test Restaurant ' + new Date().toLocaleTimeString(),
                hours: '12h00-23h00',
                price: 'R$ 30-50',
                vegetarianOptions: 'Algumas',
                access: 'Simples',
                description: 'Restaurant for testing Firebase connection',
                averageQuality: 4.5,
                totalRatings: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            firebase.firestore().collection('restaurants').add(restaurantData)
                .then((docRef) => {
                    resultDiv.innerHTML = `‚úÖ Restaurant added with ID: ${docRef.id}`;
                    resultDiv.className = 'text-success';
                })
                .catch((error) => {
                    resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                    resultDiv.className = 'text-danger';
                });
        }

        // Add test review
        function addTestReview() {
            const resultDiv = document.getElementById('review-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Adding...';

            const reviewData = {
                restaurantId: 'test-restaurant',
                userName: 'Test User',
                userFingerprint: 'test-fingerprint-' + Date.now(),
                quality: 4.5,
                price: 4.0,
                access: 'Simples',
                vegetarianOptions: 'Algumas',
                comment: 'Test review for Firebase connection',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            firebase.firestore().collection('reviews').add(reviewData)
                .then((docRef) => {
                    resultDiv.innerHTML = `‚úÖ Review added with ID: ${docRef.id}`;
                    resultDiv.className = 'text-success';
                })
                .catch((error) => {
                    resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                    resultDiv.className = 'text-danger';
                });
        }

        // Test file upload
        function testFileUpload() {
            const fileInput = document.getElementById('test-file');
            const resultDiv = document.getElementById('upload-result');

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '‚ö†Ô∏è Please select a file first';
                resultDiv.className = 'text-warning';
                return;
            }

            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Uploading...';

            const file = fileInput.files[0];
            const storageRef = firebase.storage().ref('restaurant-photos/test-' + Date.now() + '-' + file.name);

            storageRef.put(file)
                .then((snapshot) => {
                    return snapshot.ref.getDownloadURL();
                })
                .then((downloadURL) => {
                    resultDiv.innerHTML = `‚úÖ File uploaded successfully!<br><small>URL: ${downloadURL}</small>`;
                    resultDiv.className = 'text-success';
                })
                .catch((error) => {
                    resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                    resultDiv.className = 'text-danger';
                });
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testFirestore();
                testStorage();
            }, 1000);
        });
    </script>
</body>
</html>