<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Firebase Simple Integration</title>
    <meta name="description" content="Simple test page for Firebase integration">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../src/styles.css">

    <!-- Firebase Configuration (embedded) -->
    <script>
        // Firebase Configuration for Esplanada Eats
        const firebaseConfig = {
            apiKey: "AIzaSyBL8Juo6PJQtFJx1KoJU7KGlc_OndCF3Ls",
            authDomain: "esplanada-eats.firebaseapp.com",
            projectId: "esplanada-eats",
            storageBucket: "esplanada-eats.firebasestorage.app",
            messagingSenderId: "403394772779",
            appId: "1:403394772779:web:8db461c61fc21f9e418f6e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize services
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // Enable offline persistence
        db.enablePersistence({ synchronizeTabs: true })
            .then(() => {
                console.log('‚úÖ Firestore offline persistence enabled');
                updateConnectionStatus(true);
            })
            .catch((err) => {
                console.error('‚ùå Firestore persistence error:', err);
                updateConnectionStatus(false);
            });

        // Database references
        const restaurantsRef = db.collection('restaurants');
        const reviewsRef = db.collection('reviews');
        const storageRef = storage.ref();
        const photosRef = storageRef.child('restaurant-photos');

        // Connection status update
        function updateConnectionStatus(isOnline) {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');

            if (statusElement && statusText) {
                if (isOnline) {
                    statusElement.className = 'alert alert-success text-center';
                    statusText.textContent = '‚úÖ Conectado ao Firebase';
                } else {
                    statusElement.className = 'alert alert-warning text-center';
                    statusText.textContent = '‚ö†Ô∏è Offline - Modo offline ativado';
                }
            }
        }

        // Monitor online/offline status
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));

        console.log('üöÄ Firebase initialized successfully');
    </script>
</head>
<body>
    <div class="container">
        <header class="text-center py-4">
            <h1>üî• Test: Firebase Simple Integration</h1>
            <p class="lead">Vers√£o simplificada para testar conex√£o Firebase</p>
        </header>

        <main>
            <!-- Connection Status -->
            <div id="connection-status" class="alert alert-info text-center">
                <span id="status-text">Inicializando Firebase...</span>
            </div>

            <!-- Firebase Status -->
            <section class="my-4">
                <h2>Status do Firebase</h2>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Firebase App</h5>
                            </div>
                            <div class="card-body">
                                <div id="firebase-app-status">‚è≥ Verificando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Firestore</h5>
                            </div>
                            <div class="card-body">
                                <div id="firestore-status">‚è≥ Verificando...</div>
                                <button class="btn btn-primary btn-sm mt-2" onclick="testFirestore()">
                                    Testar Conex√£o
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Storage</h5>
                            </div>
                            <div class="card-body">
                                <div id="storage-status">‚è≥ Verificando...</div>
                                <button class="btn btn-primary btn-sm mt-2" onclick="testStorage()">
                                    Testar Conex√£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Test Operations -->
            <section class="my-4">
                <h2>Opera√ß√µes de Teste</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Restaurantes</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success mb-2" onclick="addTestRestaurant()">
                                    Adicionar Restaurante Teste
                                </button>
                                <button class="btn btn-info mb-2" onclick="getRestaurants()">
                                    Listar Restaurantes
                                </button>
                                <div id="restaurant-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Avalia√ß√µes</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success mb-2" onclick="addTestReview()">
                                    Adicionar Avalia√ß√£o Teste
                                </button>
                                <button class="btn btn-info mb-2" onclick="getReviews()">
                                    Listar Avalia√ß√µes
                                </button>
                                <div id="review-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- File Upload Test -->
            <section class="my-4">
                <h2>Teste de Upload de Arquivos</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Upload de Imagem</h5>
                            </div>
                            <div class="card-body">
                                <input type="file" id="test-file" accept="image/*" class="form-control mb-2">
                                <button class="btn btn-primary" onclick="testFileUpload()">
                                    Fazer Upload
                                </button>
                                <div id="upload-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Console Log</h5>
                            </div>
                            <div class="card-body">
                                <div id="console-log" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;"></div>
                                <button class="btn btn-secondary btn-sm mt-2" onclick="clearConsole()">
                                    Limpar Console
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Test Scripts -->
    <script>
        // Override console.log to display in page
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('LOG', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('ERROR', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('WARN', args.join(' '));
        };

        function addToConsole(type, message) {
            const logDiv = document.getElementById('console-log');
            if (logDiv) {
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'ERROR' ? '#dc3545' : type === 'WARN' ? '#ffc107' : '#28a745';
                logDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 2px;">[${timestamp}] ${type}: ${message}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        function clearConsole() {
            document.getElementById('console-log').innerHTML = '';
        }

        // Initialize status checks
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkFirebaseStatus();
            }, 1000);
        });

        function checkFirebaseStatus() {
            // Check Firebase App
            if (firebase.apps && firebase.apps.length > 0) {
                document.getElementById('firebase-app-status').innerHTML = '<span style="color: #28a745;">‚úÖ Firebase App Initialized</span>';
                console.log('‚úÖ Firebase App initialized successfully');
            } else {
                document.getElementById('firebase-app-status').innerHTML = '<span style="color: #dc3545;">‚ùå Firebase App Failed</span>';
                console.error('‚ùå Firebase App initialization failed');
            }

            // Check Firestore
            if (db) {
                document.getElementById('firestore-status').innerHTML = '<span style="color: #28a745;">‚úÖ Firestore Ready</span>';
                console.log('‚úÖ Firestore initialized successfully');
            } else {
                document.getElementById('firestore-status').innerHTML = '<span style="color: #dc3545;">‚ùå Firestore Failed</span>';
                console.error('‚ùå Firestore initialization failed');
            }

            // Check Storage
            if (storage) {
                document.getElementById('storage-status').innerHTML = '<span style="color: #28a745;">‚úÖ Storage Ready</span>';
                console.log('‚úÖ Storage initialized successfully');
            } else {
                document.getElementById('storage-status').innerHTML = '<span style="color: #dc3545;">‚ùå Storage Failed</span>';
                console.error('‚ùå Storage initialization failed');
            }

            // Update connection status
            updateConnectionStatus(navigator.onLine);
        }

        function testFirestore() {
            console.log('üîç Testing Firestore connection...');
            const statusDiv = document.getElementById('firestore-status');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

            // Try to write a test document
            const testRef = db.collection('connection-tests').doc('test-' + Date.now());
            testRef.set({
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                message: 'Connection test',
                test: true
            })
            .then(() => {
                statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Firestore Connection OK</span>';
                console.log('‚úÖ Firestore connection test successful');
            })
            .catch((error) => {
                statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error: ${error.message}</span>`;
                console.error('‚ùå Firestore connection test failed:', error);
            });
        }

        function testStorage() {
            console.log('üîç Testing Storage connection...');
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

            try {
                const testRef = storage.ref('test-connection');
                statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Storage Connection OK</span>';
                console.log('‚úÖ Storage connection test successful');
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error: ${error.message}</span>`;
                console.error('‚ùå Storage connection test failed:', error);
            }
        }

        function addTestRestaurant() {
            console.log('üçΩÔ∏è Adding test restaurant...');
            const resultDiv = document.getElementById('restaurant-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Adding...';

            const restaurantData = {
                name: 'Test Restaurant ' + new Date().toLocaleTimeString(),
                hours: '12h00-23h00',
                price: 'R$ 30-50',
                vegetarianOptions: 'Algumas',
                access: 'Simples',
                description: 'Restaurant for testing Firebase connection',
                averageQuality: 4.5,
                totalRatings: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            restaurantsRef.add(restaurantData)
                .then((docRef) => {
                    resultDiv.innerHTML = `<div style="color: #28a745;">‚úÖ Restaurant added with ID: ${docRef.id}</div>`;
                    console.log('‚úÖ Restaurant added successfully:', docRef.id);
                })
                .catch((error) => {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                    console.error('‚ùå Failed to add restaurant:', error);
                });
        }

        function getRestaurants() {
            console.log('üìã Getting restaurants...');
            const resultDiv = document.getElementById('restaurant-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Loading...';

            restaurantsRef.get()
                .then((snapshot) => {
                    const restaurants = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    resultDiv.innerHTML = `<div style="color: #28a745;">‚úÖ Found ${restaurants.length} restaurants</div>`;
                    restaurants.forEach(rest => {
                        resultDiv.innerHTML += `<div style="font-size: 12px; margin-left: 10px;">‚Ä¢ ${rest.name}</div>`;
                    });
                    console.log('‚úÖ Restaurants loaded:', restaurants.length);
                })
                .catch((error) => {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                    console.error('‚ùå Failed to get restaurants:', error);
                });
        }

        function addTestReview() {
            console.log('‚≠ê Adding test review...');
            const resultDiv = document.getElementById('review-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Adding...';

            const reviewData = {
                restaurantId: 'test-restaurant',
                userName: 'Test User',
                userFingerprint: 'test-fingerprint-' + Date.now(),
                quality: 4.5,
                price: 4.0,
                access: 'Simples',
                vegetarianOptions: 'Algumas',
                comment: 'Test review for Firebase connection',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            reviewsRef.add(reviewData)
                .then((docRef) => {
                    resultDiv.innerHTML = `<div style="color: #28a745;">‚úÖ Review added with ID: ${docRef.id}</div>`;
                    console.log('‚úÖ Review added successfully:', docRef.id);
                })
                .catch((error) => {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                    console.error('‚ùå Failed to add review:', error);
                });
        }

        function getReviews() {
            console.log('üìù Getting reviews...');
            const resultDiv = document.getElementById('review-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Loading...';

            reviewsRef.get()
                .then((snapshot) => {
                    const reviews = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    resultDiv.innerHTML = `<div style="color: #28a745;">‚úÖ Found ${reviews.length} reviews</div>`;
                    reviews.forEach(review => {
                        resultDiv.innerHTML += `<div style="font-size: 12px; margin-left: 10px;">‚Ä¢ ${review.userName} - ${review.quality}/5</div>`;
                    });
                    console.log('‚úÖ Reviews loaded:', reviews.length);
                })
                .catch((error) => {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                    console.error('‚ùå Failed to get reviews:', error);
                });
        }

        function testFileUpload() {
            const fileInput = document.getElementById('test-file');
            const resultDiv = document.getElementById('upload-result');

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div style="color: #ffc107;">‚ö†Ô∏è Please select a file first</div>';
                return;
            }

            console.log('üì§ Testing file upload...');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Uploading...';

            const file = fileInput.files[0];
            const fileName = `test-${Date.now()}-${file.name}`;
            const fileRef = storageRef.child('test-uploads/' + fileName);

            fileRef.put(file)
                .then((snapshot) => {
                    console.log('‚úÖ File uploaded successfully');
                    return snapshot.ref.getDownloadURL();
                })
                .then((downloadURL) => {
                    resultDiv.innerHTML = `<div style="color: #28a745;">‚úÖ File uploaded successfully!</div>`;
                    resultDiv.innerHTML += `<div style="font-size: 12px;">URL: ${downloadURL.substring(0, 50)}...</div>`;
                    console.log('‚úÖ Download URL:', downloadURL);
                })
                .catch((error) => {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                    console.error('‚ùå File upload failed:', error);
                });
        }

        console.log('üöÄ Simple Firebase Test Page Loaded');
    </script>
</body>
</html>