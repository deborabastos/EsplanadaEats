<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpeza Completa do Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #c82333;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .step {
            background: #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Limpeza Completa do Firebase</h1>

        <div class="danger">
            <strong>‚ö†Ô∏è ATEN√á√ÉO M√ÅXIMA!</strong><br>
            Esta ferramenta ir√° apagar PERMANENTEMENTE:<br>
            ‚Ä¢ üçΩÔ∏è Todos os restaurantes e seus dados<br>
            ‚Ä¢ ‚≠ê Todas as avalia√ß√µes e coment√°rios<br>
            ‚Ä¢ üë§ Todos os dados de rastreamento de usu√°rios<br>
            ‚Ä¢ üîí Todos os logs de seguran√ßa<br>
            ‚Ä¢ üì∏ Todas as fotos do Storage<br><br>
            <strong>Esta a√ß√£o N√ÉO PODE ser desfeita!</strong>
        </div>

        <div class="warning">
            <strong>üìã Status Atual:</strong><br>
            ‚Ä¢ Restaurantes: ‚úÖ Limpos<br>
            ‚Ä¢ Avalia√ß√µes: ‚úÖ Limpas<br>
            ‚Ä¢ UserTracking: ‚ö†Ô∏è 10 itens restantes<br>
            ‚Ä¢ SecurityLogs: ‚ö†Ô∏è Pode existir<br>
            ‚Ä¢ Storage Fotos: ‚ö†Ô∏è Sem permiss√£o<br>
        </div>

        <div>
            <button id="clearUserTrackingBtn" class="btn" onclick="clearUserTracking()">
                üë§ Limpar UserTracking
            </button>
            <button id="clearSecurityLogsBtn" class="btn" onclick="clearSecurityLogs()">
                üîí Limpar Security Logs
            </button>
            <button id="clearStorageBtn" class="btn" onclick="clearStorage()">
                üì∏ Limpar Storage
            </button>
            <button id="clearAllBtn" class="btn" onclick="clearAllComplete()">
                üóëÔ∏è LIMPAR TUDO COMPLETO
            </button>
            <button class="btn btn-secondary" onclick="verifyAfterCleanup()">
                üîç Verificar P√≥s-Limpeza
            </button>
            <button class="btn btn-secondary" onclick="location.href='verify-cleanup.html'">
                üìä Verificar Status
            </button>
        </div>

        <div id="log" class="log">Aguardando a√ß√£o de limpeza completa...</div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="src/firebase-config.js?v=2.1.0"></script>

    <script>
        const logElement = document.getElementById('log');
        const clearUserTrackingBtn = document.getElementById('clearUserTrackingBtn');
        const clearSecurityLogsBtn = document.getElementById('clearSecurityLogsBtn');
        const clearStorageBtn = document.getElementById('clearStorageBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setButtonState(button, disabled, text) {
            button.disabled = disabled;
            button.textContent = text;
        }

        async function clearUserTracking() {
            try {
                setButtonState(clearUserTrackingBtn, true, 'üîÑ Limpando...');
                log('üóëÔ∏è Iniciando limpeza do UserTracking...');

                const { firebase } = window.EsplanadaEatsFirebase;
                const db = firebase.firestore();

                // Get all userTracking documents
                const snapshot = await db.collection('userTracking').get();
                log(`üìä Encontrados ${snapshot.size} documentos de userTracking`);

                if (snapshot.size === 0) {
                    log('‚úÖ UserTracking j√° est√° vazio', 'success');
                    return;
                }

                // Delete all documents
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });

                await Promise.all(deletePromises);
                log(`‚úÖ ${snapshot.size} documentos de userTracking apagados com sucesso!`, 'success');

            } catch (error) {
                log(`‚ùå Erro ao limpar userTracking: ${error.message}`, 'error');
            } finally {
                setButtonState(clearUserTrackingBtn, false, 'üë§ Limpar UserTracking');
            }
        }

        async function clearSecurityLogs() {
            try {
                setButtonState(clearSecurityLogsBtn, true, 'üîÑ Limpando...');
                log('üîí Iniciando limpeza dos Security Logs...');

                const { firebase } = window.EsplanadaEatsFirebase;
                const db = firebase.firestore();

                // Get all security_logs documents
                const snapshot = await db.collection('security_logs').get();
                log(`üìä Encontrados ${snapshot.size} documentos de security logs`);

                if (snapshot.size === 0) {
                    log('‚úÖ Security Logs j√° est√° vazio', 'success');
                    return;
                }

                // Delete all documents
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });

                await Promise.all(deletePromises);
                log(`‚úÖ ${snapshot.size} documentos de security logs apagados com sucesso!`, 'success');

            } catch (error) {
                log(`‚ùå Erro ao limpar security logs: ${error.message}`, 'error');
            } finally {
                setButtonState(clearSecurityLogsBtn, false, 'üîí Limpar Security Logs');
            }
        }

        async function clearStorage() {
            try {
                setButtonState(clearStorageBtn, true, 'üîÑ Limpando...');
                log('üì∏ Iniciando limpeza do Storage...');

                const { firebase } = window.EsplanadaEatsFirebase;
                const storage = firebase.storage();

                // Try to list and delete all items in restaurants folder
                try {
                    const restaurantsRef = storage.ref('restaurants');
                    const listResult = await restaurantsRef.listAll();

                    let totalDeleted = 0;
                    const deletePromises = [];

                    // Delete all items
                    listResult.items.forEach(itemRef => {
                        deletePromises.push(itemRef.delete().then(() => {
                            totalDeleted++;
                            log(`üì∏ Apagado: ${itemRef.name}`);
                        }));
                    });

                    // Delete all subfolders recursively
                    for (const folderRef of listResult.prefixes) {
                        const subListResult = await folderRef.listAll();
                        subListResult.items.forEach(itemRef => {
                            deletePromises.push(itemRef.delete().then(() => {
                                totalDeleted++;
                                log(`üì∏ Apagado: ${folderRef.name}/${itemRef.name}`);
                            }));
                        });
                    }

                    await Promise.all(deletePromises);
                    log(`‚úÖ ${totalDeleted} arquivos do storage apagados com sucesso!`, 'success');

                } catch (storageError) {
                    if (storageError.code === 'storage/unauthorized') {
                        log('‚ö†Ô∏è Sem permiss√£o para acessar Storage. Tentando m√©todo alternativo...', 'warning');

                        // Alternative: try to access specific folders
                        const folders = ['restaurants', 'images', 'photos'];
                        for (const folder of folders) {
                            try {
                                const folderRef = storage.ref(folder);
                                const listResult = await folderRef.listAll();
                                // Delete items if accessible
                            } catch (e) {
                                log(`‚ÑπÔ∏è Pasta ${folder} n√£o acess√≠vel ou vazia`, 'info');
                            }
                        }
                        log('‚ÑπÔ∏è Storage pode requerer permiss√µes adicionais ou j√° estar limpo', 'info');
                    } else {
                        throw storageError;
                    }
                }

            } catch (error) {
                log(`‚ùå Erro ao limpar storage: ${error.message}`, 'error');
            } finally {
                setButtonState(clearStorageBtn, false, 'üì∏ Limpar Storage');
            }
        }

        async function clearAllComplete() {
            const confirmation = prompt('Digite "APAGAR TUDO COMPLETO" para confirmar a limpeza total:');
            if (confirmation !== 'APAGAR TUDO COMPLETO') {
                log('‚ùå Confirma√ß√£o incorreta. Opera√ß√£o cancelada.', 'error');
                return;
            }

            setButtonState(clearAllBtn, true, 'üîÑ Limpando tudo...');
            log('üöÄ Iniciando limpeza COMPLETA do Firebase...');

            try {
                // Step 1: Clear UserTracking
                log('üìã Passo 1/4: Limpando UserTracking...');
                await clearUserTracking();

                // Step 2: Clear Security Logs
                log('üìã Passo 2/4: Limpando Security Logs...');
                await clearSecurityLogs();

                // Step 3: Clear Storage
                log('üìã Passo 3/4: Limpando Storage...');
                await clearStorage();

                // Step 4: Final verification
                log('üìã Passo 4/4: Verifica√ß√£o final...');
                await verifyAfterCleanup();

                log('üéâ LIMPEZA COMPLETA FINALIZADA COM SUCESSO!', 'success');
                log('‚úÖ Todos os dados do Firebase foram completamente removidos!', 'success');

                setButtonState(clearAllBtn, false, '‚úÖ Limpeza Completa Feita');

            } catch (error) {
                log(`‚ùå Erro na limpeza completa: ${error.message}`, 'error');
                setButtonState(clearAllBtn, false, '‚ùå Erro - Tentar Novamente');
            }
        }

        async function verifyAfterCleanup() {
            try {
                log('üîç Verificando status p√≥s-limpeza...');

                const { firebase } = window.EsplanadaEatsFirebase;
                const db = firebase.firestore();
                const storage = firebase.storage();

                let totalItems = 0;
                const report = [];

                // Check restaurants
                const restaurants = await db.collection('restaurants').get();
                report.push(`üçΩÔ∏è Restaurantes: ${restaurants.size} itens`);
                totalItems += restaurants.size;

                // Check ratings
                const ratings = await db.collection('ratings').get();
                report.push(`‚≠ê Avalia√ß√µes: ${ratings.size} itens`);
                totalItems += ratings.size;

                // Check userTracking
                const userTracking = await db.collection('userTracking').get();
                report.push(`üë§ UserTracking: ${userTracking.size} itens`);
                totalItems += userTracking.size;

                // Check security logs
                const securityLogs = await db.collection('security_logs').get();
                report.push(`üîí Security Logs: ${securityLogs.size} itens`);
                totalItems += securityLogs.size;

                // Check storage
                try {
                    const storageRef = storage.ref('restaurants');
                    const listResult = await storageRef.listAll();
                    const storageCount = listResult.items.length + listResult.prefixes.length;
                    report.push(`üì∏ Storage: ${storageCount} itens`);
                    totalItems += storageCount;
                } catch (e) {
                    report.push(`üì∏ Storage: Erro ao verificar - ${e.message}`);
                }

                log('üìä RELAT√ìRIO FINAL:');
                report.forEach(line => log(line));

                if (totalItems === 0) {
                    log('üéâ SUCESSO TOTAL! Firebase est√° completamente limpo!', 'success');
                } else {
                    log(`‚ö†Ô∏è Ainda restam ${totalItems} itens para limpar`, 'warning');
                }

            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üöÄ Ferramenta de limpeza completa carregada');
        log('üìã Use os bot√µes para limpar cole√ß√µes espec√≠ficas ou tudo de uma vez');
        log('‚ö†Ô∏è CUIDADO: Esta a√ß√£o √© irrevers√≠vel!');
    </script>
</body>
</html>