<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Isolado - Card Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .restaurant-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 1rem 0;
        }
        .rating {
            color: var(--warning-color, #ffc107);
            font-weight: 500;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste Isolado - Card Display</h1>

    <button class="btn" onclick="testCardDisplay()">Testar Display do Card</button>
    <button class="btn" onclick="clearLog()">Limpar Log</button>

    <div id="test-results"></div>

    <div class="log" id="log">Console aguardando...</div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="src/firebase-config.js?v=2.1.0"></script>

    <script>
        const logDiv = document.getElementById('log');
        const resultsDiv = document.getElementById('test-results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Copiar EXATAMENTE a l√≥gica do createRestaurantCard
        function createTestRestaurantCard(restaurant) {
            log('üî• CRIANDO CARD TESTE para: ' + restaurant.name, 'info');
            log('   Dados recebidos: ' + JSON.stringify(restaurant, null, 2), 'info');

            // Format rating display
            const rating = formatRating(restaurant.averageQuality || restaurant.averageOverall || 0);
            log('   Rating formatado: ' + rating, 'info');

            // Debug: Check all possible rating count fields (totalRatings has priority)
            const possibleFields = ['totalRatings', 'totalReviews', 'ratingCount', 'numRatings', 'reviewsCount', 'reviewCount'];
            let reviewCount = 0;
            let foundField = null;

            log('   Verificando campos na ordem: ' + possibleFields.join(', '), 'info');

            for (const field of possibleFields) {
                const value = restaurant[field];
                log(`   ‚Ä¢ Verificando campo "${field}": ${value} (${typeof value})`, 'info');

                if (value !== undefined && value !== null && value !== 'undefined' && value > 0) {
                    reviewCount = value;
                    foundField = field;
                    log(`   ‚úÖ ENCONTRADO no campo "${field}": ${reviewCount}`, 'success');
                    break;
                } else if (value !== undefined && value !== null && value !== 'undefined' && value >= 0) {
                    reviewCount = value;
                    foundField = field;
                    log(`   ‚úÖ ENCONTRADO (zero permitido) no campo "${field}": ${reviewCount}`, 'success');
                    break;
                }
            }

            // Final fallback: try to parse as number
            if (reviewCount === 0 && restaurant.totalRatings !== undefined) {
                reviewCount = parseInt(restaurant.totalRatings) || 0;
                foundField = 'totalRatings (fallback parse)';
                log(`   ‚úÖ FALLBACK - Parse de totalRatings: ${reviewCount}`, 'success');
            }

            const reviewText = reviewCount === 1 ? '1 avalia√ß√£o' : `${reviewCount} avalia√ß√µes`;

            // Debug logging
            log(`   üìä RESULTADO FINAL:`);
            log(`      ‚Ä¢ Campo encontrado: ${foundField}`);
            log(`      ‚Ä¢ reviewCount: ${reviewCount}`);
            log(`      ‚Ä¢ reviewText: "${reviewText}"`);

            return {
                rating: rating,
                reviewText: reviewText,
                reviewCount: reviewCount,
                foundField: foundField
            };
        }

        function formatRating(rating) {
            if (!rating || rating === 0) {
                return '<span style="color: var(--text-secondary);">Sem avalia√ß√µes</span>';
            }
            const roundedRating = Math.round(rating * 10) / 10;
            const stars = generateStars(roundedRating);
            return `${stars} <span style="font-weight: 500;">${roundedRating}</span>`;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            let stars = '';
            for (let i = 0; i < fullStars; i++) stars += '‚òÖ';
            if (hasHalfStar) stars += '‚òÜ';
            for (let i = 0; i < emptyStars; i++) stars += '‚òÜ';
            return `<span style="color: var(--warning-color, #ffc107);">${stars}</span>`;
        }

        window.testCardDisplay = async function() {
            try {
                log('üß™ INICIANDO TESTE ISOLADO...', 'info');
                resultsDiv.innerHTML = '';

                if (!window.EsplanadaEatsFirebase || !window.EsplanadaEatsFirebase.firebase) {
                    throw new Error('Firebase n√£o inicializado');
                }

                const { firebase } = window.EsplanadaEatsFirebase;
                const db = firebase.firestore();

                // Buscar restaurantes do Firebase
                const snapshot = await db.collection('restaurants').get();
                log(`üìä Encontrados ${snapshot.size} restaurantes`, 'info');

                let resultsHtml = '';

                snapshot.forEach(doc => {
                    const restaurant = doc.data();
                    const restaurantId = doc.id;

                    log(`\nüè™ Processando: ${restaurant.name} (ID: ${restaurantId})`, 'info');

                    // Testar nossa l√≥gica
                    const cardData = createTestRestaurantCard(restaurant);

                    // Criar card HTML para visualiza√ß√£o
                    resultsHtml += `
                        <div class="restaurant-card">
                            <h3>${restaurant.name}</h3>
                            <div class="rating">
                                ${cardData.rating} <span style="color: #666; font-size: 0.875rem;">(${cardData.reviewText})</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem;">
                                Campo usado: ${cardData.foundField} | Valor: ${cardData.reviewCount}
                            </div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = resultsHtml;
                log('\nüéâ TESTE CONCLU√çDO! Verifique os cards acima.', 'success');

            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            logDiv.innerHTML = 'Console limpo...';
        };

        // Auto-test on load
        window.addEventListener('load', () => {
            log('üöÄ P√°gina de teste isolado carregada');
            log('üìã Clique em "Testar Display do Card" para executar');
            setTimeout(testCardDisplay, 1000);
        });
    </script>
</body>
</html>